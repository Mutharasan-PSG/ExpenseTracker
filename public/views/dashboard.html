<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans text-gray-800">

  <!-- Sidebar -->
  <aside class="fixed top-0 left-0 h-full bg-gray-900 w-64 text-white">
    <div class="flex items-center justify-center h-20 border-b border-gray-700">
      <span class="text-2xl font-semibold">Expense Tracker</span>
    </div>
    <nav class="mt-4">
      <a href="dashboard.html" class="block py-3 px-6 hover:bg-gray-700 transition">Dashboard</a>
      <div class="group">
        <a href="#" class="block py-3 px-6 hover:bg-gray-700 transition">Income</a>
        <div class="hidden group-hover:block bg-gray-800 pl-6">
          <a href="AddIncome.html" class="block py-2 px-6 hover:bg-gray-700 transition">Add Income</a>
          <a href="UpdateIncome.html" class="block py-2 px-6 hover:bg-gray-700 transition">Update Income</a>
          <a href="DeleteIncome.html" class="block py-2 px-6 hover:bg-gray-700 transition">Delete Income</a>
        </div>
      </div>
      <div class="group">
        <a href="#" class="block py-3 px-6 hover:bg-gray-700 transition">Expense</a>
        <div class="hidden group-hover:block bg-gray-800 pl-6">
          <a href="AddExpense.html" class="block py-2 px-6 hover:bg-gray-700 transition">Add Expense</a>
          <a href="UpdateExpense.html" class="block py-2 px-6 hover:bg-gray-700 transition">Update Expense</a>
          <a href="DeleteExpense.html" class="block py-2 px-6 hover:bg-gray-700 transition">Delete Expense</a>
        </div>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 min-h-screen p-6 bg-gray-100">
    <!-- Header -->
    <header class="flex justify-between items-center bg-white p-6 shadow rounded-lg">
      <h1 id="welcome-message" class="text-xl font-semibold">Welcome, <span id="username">User</span>!</h1>
      <a href="/logout" class="text-blue-500 hover:text-blue-700 font-medium">Logout</a>
    </header>

    <!-- Dashboard Metrics -->
    <section class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Current Balance Card -->
      <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
        <h2 class="text-sm font-medium text-gray-500">Current Balance</h2>
        <p class="mt-2 text-3xl font-bold text-gray-900">$<span id="current-balance">0</span></p>
        <p class="mt-1 text-sm text-gray-400">Updated in real-time</p>
      </div>

      <!-- Monthly Income Card -->
      <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
        <h2 class="text-sm font-medium text-gray-500">Income This Month</h2>
        <p class="mt-2 text-3xl font-bold text-green-600">$<span id="monthly-income">0</span></p>
        <p class="mt-1 text-sm text-gray-400">Based on logged entries</p>
      </div>

      <!-- Monthly Expenses Card -->
      <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
        <h2 class="text-sm font-medium text-gray-500">Expenses This Month</h2>
        <p class="mt-2 text-3xl font-bold text-red-600">$<span id="monthly-expenses">0</span></p>
        <p class="mt-1 text-sm text-gray-400">Calculated from logs</p>
      </div>
    </section>

   <!-- Recent Transactions -->
<section class="mt-10 bg-white rounded-lg shadow p-6">
  <h2 class="text-lg font-semibold mb-4">Recent Transactions</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-gray-50 border-collapse">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">Date</th>
          <th class="py-3 px-6 text-left">Category</th>
          <th class="py-3 px-6 text-left">Description</th>
          <th class="py-3 px-6 text-left">Image</th>
          <th class="py-3 px-6 text-right">Amount</th>
          <th class="py-3 px-6 text-middle">Actions</th>
        </tr>
      </thead>
      <tbody id="transactions">
        <!-- Dynamic transactions will be injected here -->
      </tbody>
    </table>
  </div>
</section>

<!-- Modal for Image -->
<div id="imageModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center hidden">
  <div class="relative bg-white rounded-lg p-4">
    <button onclick="closeModal()" class="absolute top-2 right-2 text-white bg-gray-700 px-3 py-1 rounded-full">Close</button>
    <img id="modalImage" src="" alt="Transaction Image" class="max-w-full max-h-full rounded-lg">
  </div>
</div>


 <!-- Delete Confirmation Modal -->
 <div id="deleteModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center hidden">
  <div class="bg-white rounded-lg p-6 w-1/3 text-center">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Are you sure you want to delete this transaction?</h3>
    <div class="flex justify-center gap-4">
      <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded-lg">Yes, Delete</button>
      <button id="cancelDelete" class="bg-gray-600 text-white px-4 py-2 rounded-lg">Cancel</button>
    </div>
  </div>
</div>

<!-- Notification -->
<div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-5 transition-all duration-300">
  <!-- Notification message will be injected here -->
</div>



  <script>
   // Fetch the username from session data
fetch('/api/getUsername')
.then(response => response.json())
.then(data => {
  document.getElementById('username').textContent = data.username || 'Guest';
});

const fetchDashboardData = () => {
  console.log('Refreshing dashboard data...'); // Debugging step
  // Fetch both income and expense data separately
  Promise.all([
    fetch('/api/getTransactions').then(response => response.json()), // Fetch incomes
    fetch('/api/getExpense').then(response => response.json()) // Fetch expenses
  ])
    .then(([incomeData, expenseData]) => {
      const transactionsElement = document.getElementById('transactions');
      const currentBalanceElement = document.getElementById('current-balance');
      const monthlyIncomeElement = document.getElementById('monthly-income');
      const monthlyExpensesElement = document.getElementById('monthly-expenses');
      
      let totalIncome = 0;
      let totalExpenses = 0;

      // Clear existing transactions
      transactionsElement.innerHTML = '';

      // Process and display income data
      incomeData.forEach(income => {
        totalIncome += income.amount; // Add income amount to total
        const row = createTransactionRow(income, true);
        transactionsElement.appendChild(row);
      });

      // Process and display expense data
      expenseData.forEach(expense => {
        totalExpenses += expense.amount; // Add expense amount to total
        const row = createTransactionRow(expense, false);
        transactionsElement.appendChild(row);
      });

      // Update the dashboard metrics
      currentBalanceElement.textContent = (totalIncome - totalExpenses).toFixed(2);
      monthlyIncomeElement.textContent = totalIncome.toFixed(2);
      monthlyExpensesElement.textContent = totalExpenses.toFixed(2);
    })
    .catch(error => {
      console.error('Error fetching transactions or expenses:', error);
    });
};

// Function to create a transaction row dynamically
const createTransactionRow = (transaction, isIncome) => {
  const row = document.createElement('tr');

  const description = transaction.description || '-';
  const image = transaction.image
    ? `<a href="${transaction.image}" target="_blank" class="text-blue-600 underline">Click here</a>`
    : '-';
  const amountClass = isIncome ? 'text-green-600' : 'text-red-600';

  row.innerHTML = `
  <td class="py-3 px-6">${new Date(transaction.date).toLocaleDateString()}</td>
  <td class="py-3 px-6">${transaction.category}</td>
  <td class="py-3 px-6">${description}</td>
  <td class="py-3 px-6">${image}</td>
  <td class="py-3 px-6 text-right ${amountClass}">
    $${transaction.amount.toFixed(2)}
  </td>
  <td>
    <button class="text-blue-500 hover:text-blue-700" onclick="editTransaction('${transaction._id}', ${isIncome})">Edit</button>
    <button class="text-red-500 hover:text-red-700" onclick="deleteTransaction('${transaction._id}', ${isIncome})">Delete</button>
  </td>
`;


  return row;
};


// Edit transaction handler
const editTransaction = (transactionId, isIncome) => {
  if (isIncome) {
    window.location.href = `./UpdateIncome.html?id=${transactionId}`;
  } else {
    window.location.href = `./UpdateExpense.html?id=${transactionId}`;
  }
};


let transactionIdToDelete = null;
let isIncomeToDelete = null;

// Open the modal with proper parameters
const deleteTransaction = (transactionId, isIncome) => {
  transactionIdToDelete = transactionId;
  isIncomeToDelete = isIncome;
  openDeleteModal();
};

const openDeleteModal = () => {
  document.getElementById('deleteModal').classList.remove('hidden');
};

// Close the modal
const closeDeleteModal = () => {
  const deleteModal = document.getElementById('deleteModal');
  deleteModal.classList.add('hidden');
  transactionIdToDelete = null;
  isIncomeToDelete = null;
};


// Confirm deletion logic
document.getElementById('confirmDelete').addEventListener('click', () => {
  const deleteApi = isIncomeToDelete
    ? `/api/deleteIncome/${transactionIdToDelete}`
    : `/api/deleteExpense/${transactionIdToDelete}`;

  fetch(deleteApi, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
      console.log('Delete response:', data); // Debugging step
      closeDeleteModal();
      if (data.success) {
        showNotification('Transaction deleted successfully!', 'success');
        fetchDashboardData(); // Refresh the transactions
      } else {
        showNotification('Failed to delete the transaction. Please try again.', 'error');
      }
    })
    .catch(() => {
      closeDeleteModal();
      console.error('API call failed:', err); // Log the actual error
      showNotification('An error occurred. Please try again.', 'error');
    });
});

// Cancel deletion
document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);


// Function to show notification
const showNotification = (message, type = 'success') => {
const notification = document.getElementById('notification');

// Set the message text
notification.textContent = message;

// Set the background color based on the type (success or error)
if (type === 'error') {
  notification.classList.remove('bg-green-500');
  notification.classList.add('bg-red-500');
} else {
  notification.classList.remove('bg-red-500');
  notification.classList.add('bg-green-500');
}

// Show the notification with animation
notification.classList.remove('opacity-0', 'translate-y-5');
notification.classList.add('opacity-100', 'translate-y-0');

// Hide the notification after 3 seconds
setTimeout(() => {
  notification.classList.remove('opacity-100', 'translate-y-0');
  notification.classList.add('opacity-0', 'translate-y-5');
}, 3000); // Hides the notification after 3 seconds
};


// Function to parse the URL hash and show the notification
const parseNotificationFromHash = () => {
  console.log(window.location.hash); // Check if the hash exists

  const hash = window.location.hash.substring(1); // Remove the leading '#'
  const params = new URLSearchParams(hash);

  const notification = params.get('notification');
  const message = params.get('message');

  if (notification && message) {
    showNotification(decodeURIComponent(message), notification);
  }
};

// Call functions on page load
window.onload = () => {
  parseNotificationFromHash();   // Parse the notification hash when the page loads
fetchDashboardData();
};


  </script>

</body>
</html>