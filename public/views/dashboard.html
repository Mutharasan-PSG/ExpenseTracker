<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    .sidebar-bg {
      background: linear-gradient(135deg,#eaeced,#1347cb);
      font-size: 1.2rem;
    }

    .logo {
      font-size: 2rem;
      font-weight: 700;
      max-width: 200px;  /* Adjust the maximum width as per your design */
      height: auto;  /* Maintain aspect ratio */
      width: 100%;  /* Makes the image responsive */
    }


    .hover-link:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .hover-card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .table-row:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .actions button {
      padding: 5px 10px;
      border-radius: 5px;
    }

    .actions button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .hover-card {
      display: flex;
      flex-direction: column; /* Stack content vertically */
      align-items: center; /* Horizontally center the content */
      justify-content: center; /* Vertically center the content */
      text-align: center; /* Center align the text */
      padding: 1.5rem; /* Maintain spacing inside the card */
      border-radius: 8px; /* Slightly rounded corners for a professional look */
      background-color: white; /* Ensure the background is consistent */
      transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions */
    }
    
    .hover-card:hover {
      transform: translateY(-5px); /* Slight lift on hover */
      box-shadow: 0px 10px 20px rgba(0, 0, 0, 0.1); /* Enhanced shadow on hover */
    }
    

    /* Modal Style */
    .modal-content {
      background: white;
      padding: 12px;
      border-radius: 5px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-content h3 {
      font-size: 16px;
      font-weight: normal;
      color: #333;
    }

    .modal-content p {
      font-size: 14px;
      color: #666;
    }

    /* Close Button */
    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: transparent;
      border: none;
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
    }

    .close-button:hover {
      color: #333;
    }

    /* General Button Style */
    button {
      background-color: #007bff;
      color: white;
      padding: 2px 4px;
      font-size: 10px;
      border-radius: 1px;
      border: none;
      cursor: pointer;
    }

 /*   button:hover {
      background-color: #0056b3;
    } */

    .cancel-button {
      background-color: #f0f0f0;
      color: #333;
      padding: 2px 4px;
    }

    .cancel-button:hover {
      background-color: #ddd;
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-800">
  <!-- Sidebar -->
  <aside class="fixed top-0 left-0 h-full w-64 sidebar-bg text-white shadow-lg">
    <div class="flex items-center justify-center h-20 border-b border-black">
      <img src="assets/TracEase.png"alt="Expense Tracker" class="logo">
    </div>
    <nav class="mt-4 space-y-1">
      <a href="dashboard.html" class="block py-3 px-6 hover-link rounded">üè† DASHBOARD</a>
      <a href="AddIncome.html" class="block py-3 px-6 hover-link rounded">üí∞ ADD INCOME</a>
      <a href="AddExpense.html" class="block py-3 px-6 hover-link rounded">üìâ ADD EXPENSE</a>
      <a href="visualization.html" class="block py-3 px-6 hover-link rounded">üìä VISUALIZE</a>
    </nav>
  </aside>


   <!-- Main Content -->
   <main class="ml-64 min-h-screen p-8 bg-gray-100">
    <!-- Header -->
    <header class="flex justify-between items-center bg-gradient-to-r from-blue-600 to-indigo-780 text-white p-6 shadow-lg rounded-lg">
      <h1 id="welcome-message" class="text-2xl font-semibold">Welcome, <span id="username">User</span>!</h1>
      <a href="/logout" class="flex items-center text-black font-medium hover:underline">
        <img src="assets/logo.png" alt="Logo" class="w-6 h-6 mr-2"> Logout
      </a>
    </header>
    

    <!-- Dashboard Metrics -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
      <div class="hover-card">
        <h2 class="text-gray-500">CURRENT BALANCE</h2>
        <p class="mt-2 text-2xl font-bold text-gray-900">‚Çπ<span id="current-balance">0</span></p>
        <h6 class="text-gray-400">Updated in Real-time</h6>
      </div>
      <div class="hover-card">
        <h2 class="text-gray-500">INCOME</h2>
        <p class="mt-2 text-2xl font-bold text-green-600">‚Çπ<span id="monthly-income">0</span></p>
        <h6 class="text-gray-400">Based on Logged Entries</h6>
      </div>
      <div class="hover-card">
        <h2 class="text-gray-500">EXPENSE</h2>
        <p class="mt-2 text-2xl font-bold text-red-600">‚Çπ<span id="monthly-expenses">0</span></p>
        <h6 class="text-gray-400">Calculated from Logs</h6>
      </div>
    </section>
    

<!-- Recent Transactions -->
<section class="mt-12 bg-white rounded-lg shadow-lg p-6">
  <h2 class="text-xl font-semibold text-gray-700 mb-6">TRANSCATIONS</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-gray-50 border-collapse text-sm">
      <thead>
        <tr class="bg-gray-200 text-gray-700 uppercase leading-normal">
          <th class="py-3 px-6 text-left">Date</th>
          <th class="py-3 px-6 text-left">Category</th>
          <th class="py-3 px-6 text-left">Description</th>
          <th class="py-3 px-6 text-left">Image</th>
          <th class="py-3 px-6 text-right">Amount</th>
          <th class="py-3 px-6 text-center">Actions</th> <!-- Removed padding here -->
        </tr>
      </thead>
      <tbody id="transactions" class="divide-y divide-gray-200">
        <tr class="table-row">
          <td class="py-3 px-6">01/12/2024</td>
          <td class="py-3 px-6">Groceries</td>
          <td class="py-3 px-6">Weekly shopping</td>
          <td class="py-3 px-6"><a href="#" class="text-blue-500 underline">View</a></td>
          <td class="py-3 px-6 text-right text-red-600">$120.00</td>
          <td class="py-3 px-6 flex justify-center"> <!-- Removed extra padding here -->
            <button class="text-blue-500 hover:text-blue-700">Edit</button>
            <button class="text-red-500 hover:text-red-700">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
   </main>

  <!-- Modal for Image -->
  <div id="imageModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center hidden transition-all duration-300">
    <div class="modal-content relative">
      <button onclick="closeModal()" class="close-button">&times;</button>
      <img id="modalImage" src="" alt="Transaction Image" class="w-full h-auto rounded-lg shadow-lg">
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center hidden transition-all duration-300">
    <div class="modal-content text-center">
      <h3 class="text-xl font-normal text-gray-800 mb-4">Do you want to delete this transaction?</h3>
      <div class="flex justify-center gap-6">
        <button id="confirmDelete" class="bg-red-400 text-white px-4 py-2 rounded-lg hover:bg-red-500 transition-all">Confirm</button>
        <button id="cancelDelete" class="cancel-button px-4 py-2 rounded-lg hover:bg-gray-250 transition-all">Cancel</button>
      </div>
    </div>
  </div>



<!-- Notification -->
<div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 translate-y-5 transition-all duration-500 pointer-events-none">
  <!-- Notification message will be injected here -->
</div>



  <script>
   // Fetch the username from session data
fetch('/api/getUsername')
.then(response => response.json())
.then(data => {
  document.getElementById('username').textContent = data.username || 'Guest';
});

const fetchDashboardData = () => {
  console.log('Refreshing dashboard data...'); // Debugging step
  Promise.all([
    fetch('/api/getTransactions').then(response => response.json()), // Fetch incomes
    fetch('/api/getExpense').then(response => response.json()) // Fetch expenses
  ])
    .then(([incomeData, expenseData]) => {
      const transactionsElement = document.getElementById('transactions');
      const currentBalanceElement = document.getElementById('current-balance');
      const monthlyIncomeElement = document.getElementById('monthly-income');
      const monthlyExpensesElement = document.getElementById('monthly-expenses');
      
      let totalIncome = 0;
      let totalExpenses = 0;

      // Combine income and expense data into a single array
      const allTransactions = [
        ...incomeData.map(item => ({ ...item, isIncome: true })),
        ...expenseData.map(item => ({ ...item, isIncome: false }))
      ];

      // Sort transactions by date in descending order
      allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Clear existing transactions
      transactionsElement.innerHTML = '';

      // Process and display sorted transactions
      allTransactions.forEach(transaction => {
        if (transaction.isIncome) totalIncome += transaction.amount;
        else totalExpenses += transaction.amount;

        const row = createTransactionRow(transaction, transaction.isIncome);
        transactionsElement.appendChild(row);
      });

      // Update the dashboard metrics
      currentBalanceElement.textContent = (totalIncome - totalExpenses).toFixed(2);
      monthlyIncomeElement.textContent = totalIncome.toFixed(2);
      monthlyExpensesElement.textContent = totalExpenses.toFixed(2);
    })
    .catch(error => {
      console.error('Error fetching transactions or expenses:', error);
    });
};

// Function to create a transaction row dynamically
const createTransactionRow = (transaction, isIncome) => {
  const row = document.createElement('tr');

  const description = transaction.description || '-';
  const image = transaction.image
    ? `<a href="${transaction.image}" target="_blank" class="text-blue-600 underline">Click here</a>`
    : '-';
  const amountClass = isIncome ? 'text-green-600' : 'text-red-600';

  row.innerHTML = `
  <td class="py-3 px-6">${new Date(transaction.date).toLocaleDateString()}</td>
  <td class="py-3 px-6">${transaction.category}</td>
  <td class="py-3 px-6">${description}</td>
  <td class="py-3 px-6">${image}</td>
  <td class="py-3 px-6 text-right ${amountClass}">
    ‚Çπ${transaction.amount.toFixed(2)}
  </td>
   <td class="text-center"> <!-- Added text-center class -->
    <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editTransaction('${transaction._id}', ${isIncome})">Edit</button>
    <button class="text-red-500 hover:text-red-700" onclick="deleteTransaction('${transaction._id}', ${isIncome})">Delete</button>
  </td>
`;


  return row;
};


// Edit transaction handler
const editTransaction = (transactionId, isIncome) => {
  if (isIncome) {
    window.location.href = `./UpdateIncome.html?id=${transactionId}`;
  } else {
    window.location.href = `./UpdateExpense.html?id=${transactionId}`;
  }
};

let transactionIdToDelete = null;
let isIncomeToDelete = null;

// Open the modal with proper parameters
const deleteTransaction = (transactionId, isIncome) => {
  transactionIdToDelete = transactionId;
  isIncomeToDelete = isIncome;
  openDeleteModal();
};

const openDeleteModal = () => {
  document.getElementById('deleteModal').classList.remove('hidden');
};

// Close the modal
const closeDeleteModal = () => {
  const deleteModal = document.getElementById('deleteModal');
  deleteModal.classList.add('hidden');
  transactionIdToDelete = null;
  isIncomeToDelete = null;
};

// Confirm deletion logic
document.getElementById('confirmDelete').addEventListener('click', () => {
  const deleteApi = isIncomeToDelete
    ? `/api/deleteIncome/${transactionIdToDelete}`
    : `/api/deleteExpense/${transactionIdToDelete}`;

  fetch(deleteApi, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
      console.log('Delete response:', data); // Debugging step
      closeDeleteModal();
      if (data.success) {
        showNotification('Transaction deleted successfully!', 'success');
        fetchDashboardData(); // Refresh the transactions
      } else {
        showNotification('Failed to delete the transaction. Please try again.', 'error');
      }
    })
    .catch((error) => {
      closeDeleteModal();
      console.error('API call failed:', error); // Log the actual error
      showNotification('An error occurred. Please try again.', 'error');
    });
});

// Cancel deletion
document.getElementById('cancelDelete').addEventListener('click', closeDeleteModal);

// Function to show notification
const showNotification = (message, type = 'success') => {
  const notification = document.getElementById('notification');

  // Set the message text
  notification.textContent = message;

  // Set the background color based on the type (success or error)
  if (type === 'error') {
    notification.classList.remove('bg-green-500');
    notification.classList.add('bg-red-500');
  } else {
    notification.classList.remove('bg-red-500');
    notification.classList.add('bg-green-500');
  }

  // Show the notification with animation
  notification.classList.remove('opacity-0', 'translate-y-5');
  notification.classList.add('opacity-100', 'translate-y-0');

  // Hide the notification after 3 seconds
  setTimeout(() => {
    notification.classList.remove('opacity-100', 'translate-y-0');
    notification.classList.add('opacity-0', 'translate-y-5');
  }, 3000); // Hides the notification after 3 seconds
};



// Function to parse the URL hash and show the notification
const parseNotificationFromHash = () => {
  console.log(window.location.hash); // Check if the hash exists

  const hash = window.location.hash.substring(1); // Remove the leading '#'
  const params = new URLSearchParams(hash);

  const notification = params.get('notification');
  const message = params.get('message');

  if (notification && message) {
    showNotification(decodeURIComponent(message), notification);
  }
};

// Call functions on page load
window.onload = () => {
  parseNotificationFromHash();   // Parse the notification hash when the page loads
fetchDashboardData();
};


  </script>

</body>
</html>