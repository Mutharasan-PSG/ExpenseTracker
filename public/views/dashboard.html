<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-gray-50 font-sans text-gray-800">

  <!-- Sidebar -->
  <aside class="fixed top-0 left-0 h-full bg-gray-900 w-64 text-white">
    <div class="flex items-center justify-center h-20 border-b border-gray-700">
      <span class="text-2xl font-semibold">Expense Tracker</span>
    </div>
    <nav class="mt-4">
      <a href="dashboard.html" class="block py-3 px-6 hover:bg-gray-700 transition">Dashboard</a>
      <div class="group">
        <a href="#" class="block py-3 px-6 hover:bg-gray-700 transition">Income</a>
        <div class="hidden group-hover:block bg-gray-800 pl-6">
          <a href="AddIncome.html" class="block py-2 px-6 hover:bg-gray-700 transition">Add Income</a>
          <a href="UpdateIncome.html" class="block py-2 px-6 hover:bg-gray-700 transition">Update Income</a>
          <a href="DeleteIncome.html" class="block py-2 px-6 hover:bg-gray-700 transition">Delete Income</a>
        </div>
      </div>
      <div class="group">
        <a href="#" class="block py-3 px-6 hover:bg-gray-700 transition">Expense</a>
        <div class="hidden group-hover:block bg-gray-800 pl-6">
          <a href="AddExpense.html" class="block py-2 px-6 hover:bg-gray-700 transition">Add Expense</a>
          <a href="UpdateExpense.html" class="block py-2 px-6 hover:bg-gray-700 transition">Update Expense</a>
          <a href="DeleteExpense.html" class="block py-2 px-6 hover:bg-gray-700 transition">Delete Expense</a>
        </div>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="ml-64 min-h-screen p-6 bg-gray-100">
    <!-- Header -->
    <header class="flex justify-between items-center bg-white p-6 shadow rounded-lg">
      <h1 id="welcome-message" class="text-xl font-semibold">Welcome, <span id="username">User</span>!</h1>
      <a href="/logout" class="text-blue-500 hover:text-blue-700 font-medium">Logout</a>
    </header>

    <!-- Dashboard Metrics -->
    <section class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Current Balance Card -->
      <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
        <h2 class="text-sm font-medium text-gray-500">Current Balance</h2>
        <p class="mt-2 text-3xl font-bold text-gray-900">$<span id="current-balance">0</span></p>
        <p class="mt-1 text-sm text-gray-400">Updated in real-time</p>
      </div>

      <!-- Monthly Income Card -->
      <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
        <h2 class="text-sm font-medium text-gray-500">Income This Month</h2>
        <p class="mt-2 text-3xl font-bold text-green-600">$<span id="monthly-income">0</span></p>
        <p class="mt-1 text-sm text-gray-400">Based on logged entries</p>
      </div>

      <!-- Monthly Expenses Card -->
      <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
        <h2 class="text-sm font-medium text-gray-500">Expenses This Month</h2>
        <p class="mt-2 text-3xl font-bold text-red-600">$<span id="monthly-expenses">0</span></p>
        <p class="mt-1 text-sm text-gray-400">Calculated from logs</p>
      </div>
    </section>

   <!-- Recent Transactions -->
<section class="mt-10 bg-white rounded-lg shadow p-6">
  <h2 class="text-lg font-semibold mb-4">Recent Transactions</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full bg-gray-50 border-collapse">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">Date</th>
          <th class="py-3 px-6 text-left">Category</th>
          <th class="py-3 px-6 text-left">Description</th>
          <th class="py-3 px-6 text-left">Image</th>
          <th class="py-3 px-6 text-right">Amount</th>
        </tr>
      </thead>
      <tbody id="transactions">
        <!-- Dynamic transactions will be injected here -->
      </tbody>
    </table>
  </div>
</section>

<!-- Modal for Image -->
<div id="imageModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex justify-center items-center hidden">
  <div class="relative bg-white rounded-lg p-4">
    <button onclick="closeModal()" class="absolute top-2 right-2 text-white bg-gray-700 px-3 py-1 rounded-full">Close</button>
    <img id="modalImage" src="" alt="Transaction Image" class="max-w-full max-h-full rounded-lg">
  </div>
</div>

  <script>
    // Fetch the username from session data
    fetch('/api/getUsername')
      .then(response => response.json())
      .then(data => {
        document.getElementById('username').textContent = data.username || 'Guest';
      });

    // Fetch the transactions from the server and update the dashboard
    fetch('/api/getTransactions')
      .then(response => response.json())
      .then(data => {
        const transactionsElement = document.getElementById('transactions');
        const currentBalanceElement = document.getElementById('current-balance');
        const monthlyIncomeElement = document.getElementById('monthly-income');
        const monthlyExpensesElement = document.getElementById('monthly-expenses');
        
        let totalIncome = 0;
        let totalExpenses = 0;
        
        // Clear any existing transactions
        transactionsElement.innerHTML = '';
        
        data.forEach(transaction => {
          const row = document.createElement('tr');
          
          const description = transaction.description || '-';
          // If image is present, display "Click here" as text; otherwise display a dash
          const image = transaction.image
          ? `<a href="${transaction.image}" target="_blank" class="text-blue-600 underline">Click here</a>`
          : '-';
          
          row.innerHTML = `
            <td class="py-3 px-6">${new Date(transaction.date).toLocaleDateString()}</td>
            <td class="py-3 px-6">${transaction.category}</td>
            <td class="py-3 px-6">${description}</td>
            <td class="py-3 px-6">${image}</td>
            <td class="py-3 px-6 text-right ${transaction.amount >= 0 ? 'text-green-600' : 'text-red-600'}">
              $${transaction.amount.toFixed(2)}
            </td>
            
          `;
          
          transactionsElement.appendChild(row);

          // Accumulate income/expenses totals
          if (transaction.amount > 0) {
            totalIncome += transaction.amount;
          } else {
            totalExpenses += transaction.amount;
          }
        });

        // Update the dashboard metrics
        currentBalanceElement.textContent = (totalIncome + totalExpenses).toFixed(2);
        monthlyIncomeElement.textContent = totalIncome.toFixed(2);
        monthlyExpensesElement.textContent = totalExpenses.toFixed(2);
      })
      .catch(error => {
        console.error('Error fetching transactions:', error);
      });

   // Open Modal and set image source
function openModal(imageSrc) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  if (imageSrc) {
    modalImage.src = imageSrc; // Set the image source dynamically
    modal.classList.remove('hidden'); // Show the modal
  } else {
    console.error("Image source is invalid or missing:", imageSrc);
  }
}

// Close Modal
function closeModal() {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  modal.classList.add('hidden'); // Hide the modal
  modalImage.src = ""; // Clear the image source
}

  </script>

</body>
</html>
